name: Codex Worker

on:
  push:
    branches: [main]
    paths:
      - 'task.md'
  workflow_dispatch:

jobs:
  codex-solve-tasks:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Check for TODO tasks
        id: check-tasks
        run: |
          if grep -q "Status: TODO" task.md; then
            echo "has_todos=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found TODO tasks"
          else
            echo "has_todos=false" >> $GITHUB_OUTPUT
            echo "âœ“ No TODO tasks, skipping"
          fi

      - name: Create task branch
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          BRANCH_NAME="codex/solve-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Run Codex to implement tasks
        if: steps.check-tasks.outputs.has_todos == 'true'
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .ai/codex.prompt.md
          output-file: codex-output.md
          sandbox: workspace-write
          safety-strategy: drop-sudo

      - name: Commit Codex solutions
        if: steps.check-tasks.outputs.has_todos == 'true'
        run: |
          git config user.name "Codex Bot"
          git config user.email "codex@openai.com"

          git add problems/

          if ! git diff --cached --quiet; then
            git commit -m "ðŸ¤– Codex: Implement TODO tasks

            Generated solutions for LeetCode problems.
            Waiting for Claude Code review."

            git push origin "$BRANCH_NAME"
          else
            echo "No changes made by Codex"
            exit 1
          fi

      - name: Create Pull Request
        if: steps.check-tasks.outputs.has_todos == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY="## ðŸ¤– Codex Implementation Report

          This PR contains automated solutions for TODO tasks in task.md.

          **Status:** Awaiting Claude Code review ðŸ‘€

          ### Codex Output
          \`\`\`
          $(cat codex-output.md 2>/dev/null || echo "No output file generated")
          \`\`\`

          ---
          ðŸ”„ Ready for manual review by Claude Code (local client)"

          # Create PR without labels first
          PR_URL=$(gh pr create \
            --title "ðŸ¤– Codex Solutions - $(date +%Y%m%d-%H%M%S)" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME")

          echo "Created PR: $PR_URL"

          # Try to add labels, but don't fail if they don't exist
          gh pr edit "$PR_URL" --add-label "codex-submission" 2>/dev/null || echo "Label 'codex-submission' not found, skipping"
          gh pr edit "$PR_URL" --add-label "needs-review" 2>/dev/null || echo "Label 'needs-review' not found, skipping"
